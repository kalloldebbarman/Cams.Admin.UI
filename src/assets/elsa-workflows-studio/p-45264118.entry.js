import{r as e,h as t,H as s}from"./p-ee0b9025.js";import{e as a}from"./p-d17a08e5.js";import{c as i}from"./p-a3b5bd35.js";import{b as l,a as n,S as r}from"./p-f3f2f442.js";import{E as o}from"./p-ec6778d3.js";import{a as c}from"./p-6cc453a9.js";import{a as d}from"./p-bc995f78.js";import{L as h,W as u}from"./p-37161c4f.js";import{T as p}from"./p-96c5f56a.js";import{f}from"./p-f4e44994.js";import"./p-6f3ac5fa.js";import"./p-82db2ff5.js";import"./p-949334ec.js";import"./p-80de33dc.js";import"./p-f1ec68ec.js";import"./p-83f217d4.js";let y=class{constructor(s){e(this,s),this.activityContextMenuState={shown:!1,x:0,y:0,activity:null},this.layoutDirection=h.TopBottom,this.getActivityBorderColor=e=>{var t,s;const a=this.workflowInstance,i=a?a.faults:null,l=(a.activityData[e.activityId]||{})._Lifecycle||{},n=null!==(t=l.executing)&&void 0!==t?t:l.Executing,r=null!==(s=l.executed)&&void 0!==s?s:l.Executed;return i&&i.find((t=>t.faultedActivityId==e.activityId))?"red":r?"green":n?"blue":null},this.renderActivityStatsButton=e=>{var t,s;const a=this.workflowInstance,i=a?a.faults:null,l=(a.activityData[e.activityId]||{})._Lifecycle||{},n=null!==(t=l.executing)&&void 0!==t?t:l.Executing,r=null!==(s=l.executed)&&void 0!==s?s:l.Executed;let o;return o=i&&i.find((t=>t.faultedActivityId==e.activityId))?'<svg class="elsa-flex-shrink-0 elsa-h-6 elsa-w-6 elsa-text-red-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                <circle cx="12" cy="12" r="10"/>\n                <line x1="12" y1="8" x2="12" y2="12"/>\n                <line x1="12" y1="16" x2="12.01" y2="16"/>\n              </svg>':r?'<svg class="elsa-h-6 elsa-w-6 elsa-text-green-500"  viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                <circle cx="12" cy="12" r="10" />\n                <line x1="12" y1="16" x2="12" y2="12" />\n                <line x1="12" y1="8" x2="12.01" y2="8" />\n              </svg>':n?'<svg class="elsa-h-6 elsa-w-6 elsa-text-blue-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                <circle cx="12" cy="12" r="10" />\n                <line x1="12" y1="16" x2="12" y2="12" />\n                <line x1="12" y1="8" x2="12.01" y2="8" />\n              </svg>':'<svg class="h-6 w-6 text-gray-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                <circle cx="12" cy="12" r="10" />\n                <line x1="12" y1="16" x2="12" y2="12" />\n                <line x1="12" y1="8" x2="12.01" y2="8" />\n              </svg>',`<div class="context-menu-wrapper elsa-flex-shrink-0">\n            <button aria-haspopup="true"\n                    class="elsa-w-8 elsa-h-8 elsa-inline-flex elsa-items-center elsa-justify-center elsa-text-gray-400 elsa-rounded-full elsa-bg-transparent hover:elsa-text-gray-500 focus:elsa-outline-none focus:elsa-text-gray-500 focus:elsa-bg-gray-100 elsa-transition elsa-ease-in-out elsa-duration-150">\n              ${o}\n            </button>\n          </div>`},this.renderActivityPerformanceMenu=()=>{const e=this.activityStats;return t("div",{"data-transition-enter":"elsa-transition elsa-ease-out elsa-duration-100","data-transition-enter-start":"elsa-transform elsa-opacity-0 elsa-scale-95","data-transition-enter-end":"elsa-transform elsa-opacity-100 elsa-scale-100","data-transition-leave":"elsa-transition elsa-ease-in elsa-duration-75","data-transition-leave-start":"elsa-transform elsa-opacity-100 elsa-scale-100","data-transition-leave-end":"elsa-transform elsa-opacity-0 elsa-scale-95",class:(this.activityContextMenuState.shown?"":"hidden")+" elsa-absolute elsa-z-10 elsa-mt-3 elsa-px-2 elsa-w-screen elsa-max-w-xl sm:elsa-px-0",style:{left:`${this.activityContextMenuState.x+64}px`,top:this.activityContextMenuState.y-256+"px"},ref:e=>this.contextMenu=e},t("div",{class:"elsa-rounded-lg elsa-shadow-lg elsa-ring-1 elsa-ring-black elsa-ring-opacity-5 elsa-overflow-hidden"},e?t("div",null,t("div",null,t("table",{class:"elsa-min-w-full elsa-divide-y elsa-divide-gray-200 elsa-border-b elsa-border-gray-200"},t("thead",{class:"elsa-bg-gray-50"},t("tr",null,t("th",{scope:"col",class:"elsa-px-6 elsa-py-3 elsa-text-left elsa-text-xs elsa-font-medium elsa-text-gray-500 elsa-text-right elsa-tracking-wider"},"Event"),t("th",{scope:"col",class:"elsa-px-6 elsa-py-3 elsa-text-left elsa-text-xs elsa-font-medium elsa-text-gray-500 elsa-text-right elsa-tracking-wider"},"Count"))),t("tbody",{class:"elsa-bg-white elsa-divide-y elsa-divide-gray-200"},e.eventCounts.length>0?e.eventCounts.map((e=>t("tr",null,t("td",{class:"elsa-px-6 elsa-py-4 elsa-whitespace-nowrap elsa-text-sm elsa-font-medium elsa-text-gray-900"},e.eventName),t("td",{class:"elsa-px-6 elsa-py-4 elsa-whitespace-nowrap elsa-text-sm elsa-text-gray-500"},e.count)))):t("tr",null,t("td",{colSpan:2,class:"elsa-px-6 elsa-py-4 elsa-whitespace-nowrap elsa-text-sm elsa-font-medium elsa-text-gray-900"},"No events record for this activity."))))),e.eventCounts.length>0?t("div",{class:"elsa-relative elsa-grid elsa-gap-6 elsa-bg-white px-5 elsa-py-6 sm:elsa-gap-8 sm:elsa-p-8"},(()=>{if(e.fault)return t("elsa-workflow-fault-information",{workflowFault:this.workflowInstance.faults.find((e=>e.faultedActivityId==this.selectedActivityId)),faultedAt:this.workflowInstance.faultedAt})})(),(()=>{if(!e.fault)return t("elsa-workflow-performance-information",{activityStats:e})})()):void 0):t("div",{class:"elsa-p-6 elsa-bg-white"},"Loading...")))}}async getServerUrl(){return this.serverUrl}async workflowInstanceIdChangedHandler(e){const t=e;let s={id:null,definitionId:null,definitionVersionId:null,version:null,workflowStatus:l.Idle,variables:{data:{}},blockingActivities:[],scheduledActivities:[],scopes:[],currentActivity:{activityId:""}},a={id:null,version:1,activities:[],connections:[],persistenceBehavior:n.WorkflowBurst,customAttributes:{data:{}},persistWorkflow:!1,isLatest:!1,isPublished:!1,loadWorkflowContext:!1,isSingleton:!1,saveWorkflowContext:!1,variables:{data:{}},type:null,inputProperties:{data:{}},outputProperties:{data:{}},propertyStorageProviders:{}};const i=await c(this.serverUrl);if(t&&t.length>0)try{s=await i.workflowInstancesApi.get(t),a=await i.workflowRegistryApi.get(s.definitionId,{version:s.version})}catch(e){console.warn("The specified workflow definition does not exist. Creating a new one.")}this.updateModels(s,a)}async serverUrlChangedHandler(e){e&&e.length>0&&await this.loadActivityDescriptors()}onWindowClicked(e){this.contextMenu.contains(e.target)||this.handleContextMenuChange(0,0,!1,null)}async componentWillLoad(){const e=f.getFeatureConfig(f.supportedFeatures.workflowLayout);e&&e.enabled&&(this.layoutDirection=e.value),await this.serverUrlChangedHandler(this.serverUrl),await this.workflowInstanceIdChangedHandler(this.workflowInstanceId)}componentDidLoad(){this.designer||(this.designer=this.el.querySelector("elsa-designer-tree"),this.designer.model=this.workflowModel)}async loadActivityDescriptors(){const e=await c(this.serverUrl);d.activityDescriptors=await e.activitiesApi.list()}updateModels(e,t){this.workflowInstance=e,this.workflowBlueprint=t,this.workflowModel=this.mapWorkflowModel(t,e)}mapWorkflowModel(e,t){const s=e.activities.filter((t=>t.parentId==e.id||!t.parentId)).map((e=>this.mapActivityModel(e,t))),a=e.connections.filter((e=>s.findIndex((t=>t.activityId==e.sourceActivityId||t.activityId==e.targetActivityId))>-1)).map(this.mapConnectionModel);return{activities:s,connections:a,persistenceBehavior:e.persistenceBehavior}}mapActivityModel(e,t){const s=d.activityDescriptors.find((t=>t.type==e.type)),a=t.activityData[e.id]||{},l=i.map(e.inputProperties.data,((e,t)=>{const i=s.inputProperties.find((e=>e.name==t))||s.outputProperties.find((e=>e.name==t)),l=(null==i?void 0:i.defaultSyntax)||r.Literal,n={},o=a[t]||e;return n[l]=o,{name:t,value:o,expressions:n,syntax:l}}));return{activityId:e.id,description:e.description,displayName:e.displayName||e.name||e.type,name:e.name,type:e.type,properties:l,outcomes:[...s.outcomes],persistWorkflow:e.persistWorkflow,saveWorkflowContext:e.saveWorkflowContext,loadWorkflowContext:e.loadWorkflowContext,propertyStorageProviders:e.propertyStorageProviders}}mapConnectionModel(e){return{sourceId:e.sourceActivityId,targetId:e.targetActivityId,outcome:e.outcome}}handleContextMenuChange(e,t,s,a){this.activityContextMenuState={shown:s,x:e,y:t,activity:a}}onShowWorkflowSettingsClick(){a.emit(o.ShowWorkflowSettings)}onRecordSelected(e){const t=e.detail,s=t?this.workflowBlueprint.activities.find((e=>e.id===t.activityId)):null;this.selectedActivityId=null!=s?null!=s.parentId?s.parentId:s.id:null}async onActivitySelected(e){this.selectedActivityId=e.detail.activityId,await this.journal.selectActivityRecord(this.selectedActivityId)}async onActivityDeselected(e){this.selectedActivityId==e.detail.activityId&&(this.selectedActivityId=null),await this.journal.selectActivityRecord(this.selectedActivityId)}async onActivityContextMenuButtonClicked(e){if(this.activityContextMenuState=e.detail,this.activityStats=null,!e.detail.shown)return;const t=await c(this.serverUrl);this.activityStats=await t.activityStatsApi.get(this.workflowInstanceId,e.detail.activity.activityId)}render(){const e=d.activityDescriptors;return t(s,{class:"elsa-flex elsa-flex-col elsa-w-full elsa-relative",ref:e=>this.el=e},this.renderCanvas(),t("elsa-workflow-instance-journal",{ref:e=>this.journal=e,workflowInstanceId:this.workflowInstanceId,workflowInstance:this.workflowInstance,serverUrl:this.serverUrl,activityDescriptors:e,workflowBlueprint:this.workflowBlueprint,workflowModel:this.workflowModel,onRecordSelected:e=>this.onRecordSelected(e)}))}renderCanvas(){return t("div",{class:"elsa-flex-1 elsa-flex"},t("elsa-designer-tree",{model:this.workflowModel,class:"elsa-flex-1",ref:e=>this.designer=e,layoutDirection:this.layoutDirection,mode:u.Instance,activityContextMenuButton:this.renderActivityStatsButton,activityBorderColor:this.getActivityBorderColor,activityContextMenu:this.activityContextMenuState,selectedActivityIds:[this.selectedActivityId],onActivitySelected:e=>this.onActivitySelected(e),onActivityDeselected:e=>this.onActivityDeselected(e),onActivityContextMenuButtonClicked:e=>this.onActivityContextMenuButtonClicked(e)}),this.renderActivityPerformanceMenu())}static get watchers(){return{workflowInstanceId:["workflowInstanceIdChangedHandler"],serverUrl:["serverUrlChangedHandler"]}}};p.injectProps(y,["serverUrl","culture"]);export{y as elsa_workflow_instance_viewer_screen}